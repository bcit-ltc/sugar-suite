# HTTP-level logging & helpers

# Flag kubelet health probes by User-Agent
map $http_user_agent $is_probe { default 0; ~kube-probe 1; }

# Flag error statuses
map $status $is_error { default 0; ~^[45] 1; }

# Only log failing probe requests
map "$is_probe:$is_error" $log_probe_fail { default 0; "1:1" 1; }

# Log all non-probe requests (browsers/APIs)
map $is_probe $not_probe { 0 1; 1 0; }

# JSON access log for normal traffic
log_format json escape=json
  '{'
    '"ts":"$time_iso8601",'
    '"remote":"$remote_addr",'
    '"method":"$request_method",'
    '"uri":"$request_uri",'
    '"status":$status,'
    '"bytes":$body_bytes_sent,'
    '"rt":$request_time,'
    '"ref":"$http_referer",'
    '"ua":"$http_user_agent",'
    '"req_id":"$request_id"'
  '}';

# Compact format for probe logs
log_format probe '$remote_addr - $time_local "$request" $status rt=$request_time';

# Send error logs to stderr
error_log /dev/stderr warn;

# Main server
server {
  listen 8080;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # Serve precompressed gzip assets when the client supports it
  gzip_static on;
  gzip_vary on;

  # Serve precompressed brotli assets when the client supports it
  # brotli_static on;
  # brotli_vary on;
  # brotli_types text/plain text/css application/javascript application/json application/xml text/xml text/javascript image/svg+xml;

  absolute_redirect off;
  port_in_redirect off;
  server_name_in_redirect off;

  # Access logging:
  access_log /dev/stdout json  if=$not_probe;       # all non-probe requests
  access_log /dev/stdout probe if=$log_probe_fail;  # ONLY failing probes

  # Cache control for static assets (CSS, JS, images, fonts)
  # Long cache for immutable assets - these are versioned and won't change
  location ~* \.(css|js|map|jpg|jpeg|png|gif|svg|ico|mp4|woff|woff2|ttf|otf|eot)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri $uri/ =404;
  }

  # Cache control for compressed files (brotli)
  # location ~* \.(css|js)\.br$ {
  #   add_header Cache-Control "public, max-age=31536000, immutable";
  #   add_header Content-Encoding br;
  #   try_files $uri =404;
  # }

  # Cache control for compressed files (gzip)
  location ~* \.(css|js)\.gz$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Content-Encoding gzip;
    try_files $uri =404;
  }

  # HTML files - shorter cache or no-cache since they may change
  location ~* \.html$ {
    add_header Cache-Control "public, max-age=3600, must-revalidate";
    try_files $uri $uri/ =404;
  }

  # Directory listing for all other paths
  location / {
    autoindex on;
    try_files $uri $uri/ =404;
  }

  # Health endpoints
  location = /healthz {
    access_log off;
    add_header Content-Type application/json;
    return 200 '{"status":"HEALTHY"}';
  }

  location = /healthz/startup {
    access_log off;
    add_header Content-Type application/json;
    return 200 '{"status":"STARTUP_OK"}';
  }

  location = /healthz/ready {
    access_log off;
    add_header Content-Type application/json;
    return 200 '{"status":"READY_OK"}';
  }

  # Optional nice to haves
  sendfile on;
  keepalive_timeout 65s;
}
